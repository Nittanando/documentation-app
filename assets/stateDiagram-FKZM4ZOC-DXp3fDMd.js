import{Cn as e,En as t,Ft as n,I as r,Jn as i,Pt as a,gn as o,hn as s,qn as c,un as l}from"./index-CExtazMC.js";import"./_baseUniq-CFdcI2tf.js";import"./_basePickBy-S4cZKXFr.js";import{t as u}from"./dagre-DB3klAJQ.js";import{t as d}from"./graphlib-BflY4qdf.js";import"./chunk-55IACEB6-Bg-_biL7.js";import"./chunk-QN33PNHL-C4NyNKsO.js";import{i as f,n as p,t as m}from"./chunk-DI55MBZ5-Bw8D49uA.js";var h=c(t=>t.append(`circle`).attr(`class`,`start-state`).attr(`r`,e().state.sizeUnit).attr(`cx`,e().state.padding+e().state.sizeUnit).attr(`cy`,e().state.padding+e().state.sizeUnit),`drawStartState`),g=c(t=>t.append(`line`).style(`stroke`,`grey`).style(`stroke-dasharray`,`3`).attr(`x1`,e().state.textHeight).attr(`class`,`divider`).attr(`x2`,e().state.textHeight*2).attr(`y1`,0).attr(`y2`,0),`drawDivider`),_=c((t,n)=>{let r=t.append(`text`).attr(`x`,2*e().state.padding).attr(`y`,e().state.textHeight+2*e().state.padding).attr(`font-size`,e().state.fontSize).attr(`class`,`state-title`).text(n.id),i=r.node().getBBox();return t.insert(`rect`,`:first-child`).attr(`x`,e().state.padding).attr(`y`,e().state.padding).attr(`width`,i.width+2*e().state.padding).attr(`height`,i.height+2*e().state.padding).attr(`rx`,e().state.radius),r},`drawSimpleState`),v=c((t,n)=>{let r=c(function(t,n,r){let i=t.append(`tspan`).attr(`x`,2*e().state.padding).text(n);r||i.attr(`dy`,e().state.textHeight)},`addTspan`),i=t.append(`text`).attr(`x`,2*e().state.padding).attr(`y`,e().state.textHeight+1.3*e().state.padding).attr(`font-size`,e().state.fontSize).attr(`class`,`state-title`).text(n.descriptions[0]).node().getBBox(),a=i.height,o=t.append(`text`).attr(`x`,e().state.padding).attr(`y`,a+e().state.padding*.4+e().state.dividerMargin+e().state.textHeight).attr(`class`,`state-description`),s=!0,l=!0;n.descriptions.forEach(function(e){s||(r(o,e,l),l=!1),s=!1});let u=t.append(`line`).attr(`x1`,e().state.padding).attr(`y1`,e().state.padding+a+e().state.dividerMargin/2).attr(`y2`,e().state.padding+a+e().state.dividerMargin/2).attr(`class`,`descr-divider`),d=o.node().getBBox(),f=Math.max(d.width,i.width);return u.attr(`x2`,f+3*e().state.padding),t.insert(`rect`,`:first-child`).attr(`x`,e().state.padding).attr(`y`,e().state.padding).attr(`width`,f+2*e().state.padding).attr(`height`,d.height+a+2*e().state.padding).attr(`rx`,e().state.radius),t},`drawDescrState`),y=c((t,n,r)=>{let i=e().state.padding,a=2*e().state.padding,o=t.node().getBBox(),s=o.width,c=o.x,l=t.append(`text`).attr(`x`,0).attr(`y`,e().state.titleShift).attr(`font-size`,e().state.fontSize).attr(`class`,`state-title`).text(n.id),u=l.node().getBBox().width+a,d=Math.max(u,s);d===s&&(d+=a);let f,p=t.node().getBBox();n.doc,f=c-i,u>s&&(f=(s-d)/2+i),Math.abs(c-p.x)<i&&u>s&&(f=c-(u-s)/2);let m=1-e().state.textHeight;return t.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,m).attr(`class`,r?`alt-composit`:`composit`).attr(`width`,d).attr(`height`,p.height+e().state.textHeight+e().state.titleShift+1).attr(`rx`,`0`),l.attr(`x`,f+i),u<=s&&l.attr(`x`,c+(d-a)/2-u/2+i),t.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,e().state.titleShift-e().state.textHeight-e().state.padding).attr(`width`,d).attr(`height`,e().state.textHeight*3).attr(`rx`,e().state.radius),t.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,e().state.titleShift-e().state.textHeight-e().state.padding).attr(`width`,d).attr(`height`,p.height+3+2*e().state.textHeight).attr(`rx`,e().state.radius),t},`addTitleAndBox`),b=c(t=>(t.append(`circle`).attr(`class`,`end-state-outer`).attr(`r`,e().state.sizeUnit+e().state.miniPadding).attr(`cx`,e().state.padding+e().state.sizeUnit+e().state.miniPadding).attr(`cy`,e().state.padding+e().state.sizeUnit+e().state.miniPadding),t.append(`circle`).attr(`class`,`end-state-inner`).attr(`r`,e().state.sizeUnit).attr(`cx`,e().state.padding+e().state.sizeUnit+2).attr(`cy`,e().state.padding+e().state.sizeUnit+2)),`drawEndState`),x=c((t,n)=>{let r=e().state.forkWidth,i=e().state.forkHeight;if(n.parentId){let e=r;r=i,i=e}return t.append(`rect`).style(`stroke`,`black`).style(`fill`,`black`).attr(`width`,r).attr(`height`,i).attr(`x`,e().state.padding).attr(`y`,e().state.padding)},`drawForkJoinState`),S=c((t,n,r,i)=>{let a=0,o=i.append(`text`);o.style(`text-anchor`,`start`),o.attr(`class`,`noteText`);let c=t.replace(/\r\n/g,`<br/>`);c=c.replace(/\n/g,`<br/>`);let l=c.split(s.lineBreakRegex),u=1.25*e().state.noteMargin;for(let t of l){let i=t.trim();if(i.length>0){let t=o.append(`tspan`);if(t.text(i),u===0){let e=t.node().getBBox();u+=e.height}a+=u,t.attr(`x`,n+e().state.noteMargin),t.attr(`y`,r+a+1.25*e().state.noteMargin)}}return{textWidth:o.node().getBBox().width,textHeight:a}},`_drawLongText`),C=c((t,n)=>{n.attr(`class`,`state-note`);let r=n.append(`rect`).attr(`x`,0).attr(`y`,e().state.padding),i=n.append(`g`),{textWidth:a,textHeight:o}=S(t,0,0,i);return r.attr(`height`,o+2*e().state.noteMargin),r.attr(`width`,a+e().state.noteMargin*2),r},`drawNote`),w=c(function(t,n){let r=n.id,i={id:r,label:n.id,width:0,height:0},a=t.append(`g`).attr(`id`,r).attr(`class`,`stateGroup`);n.type===`start`&&h(a),n.type===`end`&&b(a),(n.type===`fork`||n.type===`join`)&&x(a,n),n.type===`note`&&C(n.note.text,a),n.type===`divider`&&g(a),n.type===`default`&&n.descriptions.length===0&&_(a,n),n.type===`default`&&n.descriptions.length>0&&v(a,n);let o=a.node().getBBox();return i.width=o.width+2*e().state.padding,i.height=o.height+2*e().state.padding,i},`drawState`),T=0,E=c(function(o,l,u){let d=c(function(e){switch(e){case m.relationType.AGGREGATION:return`aggregation`;case m.relationType.EXTENSION:return`extension`;case m.relationType.COMPOSITION:return`composition`;case m.relationType.DEPENDENCY:return`dependency`}},`getRelationType`);l.points=l.points.filter(e=>!Number.isNaN(e.y));let f=l.points,p=n().x(function(e){return e.x}).y(function(e){return e.y}).curve(a),h=o.append(`path`).attr(`d`,p(f)).attr(`id`,`edge`+T).attr(`class`,`transition`),g=``;if(e().state.arrowMarkerAbsolute&&(g=t(!0)),h.attr(`marker-end`,`url(`+g+`#`+d(m.relationType.DEPENDENCY)+`End)`),u.title!==void 0){let t=o.append(`g`).attr(`class`,`stateLabel`),{x:n,y:a}=r.calcLabelPosition(l.points),c=s.getRows(u.title),d=0,f=[],p=0,m=0;for(let e=0;e<=c.length;e++){let r=t.append(`text`).attr(`text-anchor`,`middle`).text(c[e]).attr(`x`,n).attr(`y`,a+d),o=r.node().getBBox();p=Math.max(p,o.width),m=Math.min(m,o.x),i.info(o.x,n,a+d),d===0&&(d=r.node().getBBox().height,i.info(`Title height`,d,a)),f.push(r)}let h=d*c.length;if(c.length>1){let e=(c.length-1)*d*.5;f.forEach((t,n)=>t.attr(`y`,a+n*d-e)),h=d*c.length}let g=t.node().getBBox();t.insert(`rect`,`:first-child`).attr(`class`,`box`).attr(`x`,n-p/2-e().state.padding/2).attr(`y`,a-h/2-e().state.padding/2-3.5).attr(`width`,p+e().state.padding).attr(`height`,h+e().state.padding),i.info(g)}T++},`drawEdge`),D,O={},k=c(function(){},`setConf`),A=c(function(e){e.append(`defs`).append(`marker`).attr(`id`,`dependencyEnd`).attr(`refX`,19).attr(`refY`,7).attr(`markerWidth`,20).attr(`markerHeight`,28).attr(`orient`,`auto`).append(`path`).attr(`d`,`M 19,7 L9,13 L14,7 L9,1 Z`)},`insertMarkers`),j=c(function(t,n,r,a){D=e().state;let s=e().securityLevel,c;s===`sandbox`&&(c=l(`#i`+n));let u=l(s===`sandbox`?c.nodes()[0].contentDocument.body:`body`),d=s===`sandbox`?c.nodes()[0].contentDocument:document;i.debug(`Rendering diagram `+t);let f=u.select(`[id='${n}']`);A(f);let p=a.db.getRootDoc();N(p,f,void 0,!1,u,d,a);let m=D.padding,h=f.node().getBBox(),g=h.width+m*2,_=h.height+m*2,v=g*1.75;o(f,_,v,D.useMaxWidth),f.attr(`viewBox`,`${h.x-D.padding}  ${h.y-D.padding} `+g+` `+_)},`draw`),M=c(e=>e?e.length*D.fontSizeFactor:1,`getLabelWidth`),N=c((e,t,n,r,a,o,c)=>{let l=new d({compound:!0,multigraph:!0}),f,p=!0;for(f=0;f<e.length;f++)if(e[f].stmt===`relation`){p=!1;break}n?l.setGraph({rankdir:`LR`,multigraph:!0,compound:!0,ranker:`tight-tree`,ranksep:p?1:D.edgeLengthFactor,nodeSep:p?1:50,isMultiGraph:!0}):l.setGraph({rankdir:`TB`,multigraph:!0,compound:!0,ranksep:p?1:D.edgeLengthFactor,nodeSep:p?1:50,ranker:`tight-tree`,isMultiGraph:!0}),l.setDefaultEdgeLabel(function(){return{}});let m=c.db.getStates(),h=c.db.getRelations(),g=Object.keys(m);for(let e of g){let i=m[e];n&&(i.parentId=n);let s;if(i.doc){let e=t.append(`g`).attr(`id`,i.id).attr(`class`,`stateGroup`);s=N(i.doc,e,i.id,!r,a,o,c);{e=y(e,i,r);let t=e.node().getBBox();s.width=t.width,s.height=t.height+D.padding/2,O[i.id]={y:D.compositTitleSize}}}else s=w(t,i,l);if(i.note){let e={descriptions:[],id:i.id+`-note`,note:i.note,type:`note`},n=w(t,e,l);i.note.position===`left of`?(l.setNode(s.id+`-note`,n),l.setNode(s.id,s)):(l.setNode(s.id,s),l.setNode(s.id+`-note`,n)),l.setParent(s.id,s.id+`-group`),l.setParent(s.id+`-note`,s.id+`-group`)}else l.setNode(s.id,s)}i.debug(`Count=`,l.nodeCount(),l);let _=0;h.forEach(function(e){_++,i.debug(`Setting edge`,e),l.setEdge(e.id1,e.id2,{relation:e,width:M(e.title),height:D.labelHeight*s.getRows(e.title).length,labelpos:`c`},`id`+_)}),u(l),i.debug(`Graph after layout`,l.nodes());let v=t.node();l.nodes().forEach(function(e){e!==void 0&&l.node(e)!==void 0?(i.warn(`Node `+e+`: `+JSON.stringify(l.node(e))),a.select(`#`+v.id+` #`+e).attr(`transform`,`translate(`+(l.node(e).x-l.node(e).width/2)+`,`+(l.node(e).y+(O[e]?O[e].y:0)-l.node(e).height/2)+` )`),a.select(`#`+v.id+` #`+e).attr(`data-x-shift`,l.node(e).x-l.node(e).width/2),o.querySelectorAll(`#`+v.id+` #`+e+` .divider`).forEach(e=>{let t=e.parentElement,n=0,r=0;t&&(t.parentElement&&(n=t.parentElement.getBBox().width),r=parseInt(t.getAttribute(`data-x-shift`),10),Number.isNaN(r)&&(r=0)),e.setAttribute(`x1`,0-r+8),e.setAttribute(`x2`,n-r-8)})):i.debug(`No Node `+e+`: `+JSON.stringify(l.node(e)))});let b=v.getBBox();l.edges().forEach(function(e){e!==void 0&&l.edge(e)!==void 0&&(i.debug(`Edge `+e.v+` -> `+e.w+`: `+JSON.stringify(l.edge(e))),E(t,l.edge(e),l.edge(e).relation))}),b=v.getBBox();let x={id:n||`root`,label:n||`root`,width:0,height:0};return x.width=b.width+2*D.padding,x.height=b.height+2*D.padding,i.debug(`Doc rendered`,x,l),x},`renderDoc`),P={parser:p,get db(){return new m(1)},renderer:{setConf:k,draw:j},styles:f,init:c(e=>{e.state||={},e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute},`init`)};export{P as diagram};